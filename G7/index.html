<!DOCTYPE html><html lang="zh-TW"><head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G7 Recording Lab</title>
    <style>
        :root { --primary: #00ff88; --bg: #1a1d23; --card: #252932; --text: #e0e6ed; }
        body { font-family: "Segoe UI", sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .studio-container { background: var(--card); padding: 30px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-width: 550px; width: 100%; text-align: center; border: 1px solid #333; }
        .admin-title-display { background: linear-gradient(135deg, rgba(0,255,136,0.1) 0%, rgba(0,255,136,0) 100%); border-left: 5px solid var(--primary); color: var(--primary); padding: 15px; border-radius: 8px; font-weight: bold; font-size: 22px; margin-bottom: 20px; text-align: left; }
        .reading-text { background: #2d333d; border: 1px solid #444; padding: 20px; border-radius: 16px; text-align: left; font-size: 18px; line-height: 1.7; color: #fff; margin: 15px 0; min-height: 150px; white-space: pre-wrap; }
        .input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        input, select { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #444; background: #1a1d23; color: #fff; font-size: 16px; }
        .visualizer-container { background: #111; border-radius: 12px; height: 80px; margin-bottom: 15px; border: 1px solid #333; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }
        .btn-box { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn { padding: 16px; border-radius: 14px; border: none; font-weight: bold; font-size: 17px; cursor: pointer; transition: 0.3s; }
        #startBtn { background: #e53e3e; color: #fff; }
        #stopBtn { background: #4a5568; color: #fff; }
        #uploadBtn { background: var(--primary); color: #000; grid-column: span 2; display: none; margin-top: 10px; }
        .status-bar { margin-top: 15px; font-size: 14px; color: var(--primary); font-weight: bold; }
    </style></head><body><div class="studio-container">
    <h2 style="margin:0 0 5px 0; font-size: 10px; color: #888; text-align: left; letter-spacing: 2px;">PAS ENGLISH LAB</h2>
    <div class="admin-title-display" id="mainTitle"></div>
    <div class="input-row">
        <select id="lessonSelect" onchange="switchLesson()"><option value="ch1">Chapter 1</option><option value="ch2">Chapter 2</option><option value="ch5">Chapter 5</option></select>
        <input type="text" id="studentName" placeholder="Name">
    </div>
    <div id="lessonText" class="reading-text"></div>
    <div class="visualizer-container"><canvas id="visualizer"></canvas></div>
    <audio id="teacherAudio" preload="auto" crossorigin="anonymous" playsinline></audio>
    <div class="btn-box">
        <button id="startBtn" class="btn">üî¥ START</button>
        <button id="stopBtn" class="btn" disabled>‚èπ STOP</button>
        <button id="uploadBtn" class="btn">üì§ SEND TO TEACHER</button>
    </div>
    <p id="status" class="status-bar">READY</p>
    <audio id="audioPlayer" controls style="display: none; width: 100%; margin-top: 15px;" playsinline></audio>
</div><script>
    const CLASS_NAME = "G7", BOOK_TITLE = "The Monkeys Paw", GAS_URL = "https://script.google.com/macros/s/AKfycbyqKj-_QuK1MI7b5hl3sV4p8yjeaAAriBV4I_XbTHUi46gyGBJQoBPCJey_Okbhieaf/exec";
    const lessons = {
        "ch1": { text: "'Let's have some whisky,' old Mr. White said. 'You need something to warm you on a cold night.' He got out a bottle of whisky and the two old friends began to drink and talk. The little family listened with interest to this visitor from far away and he told them many strange stories.", audio: "shadowing 1.3.mp3" },
        "ch2": { text: "This monkey's paw can do strange and wonderful things. An old Indian gave the paw to one of my friends. My friend was a soldier, too. This paw is magic because it can give three wishes to three people. But these three wishes don‚Äôt bring happiness. The old Indian wanted to teach us something - it‚Äôs never good to want to change things.", audio: "shadowing 2.2.mp3" },
        "ch5": { text: "Then Mrs. White asked the stranger, ‚Äò Can we see him? Can we see our son? Please take me to him. I want to see my son.‚Äô But the stranger answered quickly, ‚ÄòNo! It‚Äôs better not to see him. They couldn‚Äôt stop the machinery. He was in there for a long time. And at first, they couldn‚Äôt get out. He was‚Ä¶‚Ä¶‚Äô The man stopped.", audio: "shadowing 5.1.mp3" }
    };
    document.getElementById('mainTitle').innerText = BOOK_TITLE;
    function switchLesson() {
        const val = document.getElementById('lessonSelect').value;
        document.getElementById('lessonText').innerText = lessons[val].text;
        document.getElementById('teacherAudio').src = lessons[val].audio;
    }
    window.onload = switchLesson;
    
    let recorder, chunks = [], audioCtx, dest, analyser, animationId;

    function drawVisualizer() {
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        function draw() {
            animationId = requestAnimationFrame(draw);
            analyser.getByteTimeDomainData(dataArray);
            ctx.fillStyle = '#111'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 2; ctx.strokeStyle = '#00ff88'; ctx.beginPath();
            let sliceWidth = canvas.width / bufferLength, x = 0;
            for (let i = 0; i < bufferLength; i++) {
                let v = dataArray[i] / 128.0, y = v * canvas.height / 2;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                x += sliceWidth;
            }
            ctx.lineTo(canvas.width, canvas.height / 2); ctx.stroke();
        }
        draw();
    }

    document.getElementById('startBtn').onclick = async () => {
        if (!document.getElementById('studentName').value.trim()) return alert("Enter Name!");
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            await audioCtx.resume();
            dest = audioCtx.createMediaStreamDestination();
            analyser = audioCtx.createAnalyser();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const micSource = audioCtx.createMediaStreamSource(stream);
            micSource.connect(analyser); micSource.connect(dest);
            const tAudio = document.getElementById('teacherAudio');
            const tSource = audioCtx.createMediaElementSource(tAudio);
            tSource.connect(dest); tSource.connect(audioCtx.destination);

            drawVisualizer();
            recorder = new MediaRecorder(dest.stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/mp4' });
                const url = URL.createObjectURL(blob);
                const p = document.getElementById('audioPlayer');
                p.src = url; p.style.display = 'block'; p.load();
                document.getElementById('uploadBtn').style.display = 'block';
                cancelAnimationFrame(animationId);
            };
            chunks = []; tAudio.currentTime = 0; tAudio.play(); recorder.start();
            document.getElementById('startBtn').disabled = true; document.getElementById('stopBtn').disabled = false;
            document.getElementById('status').innerText = "RECORDING...";
        } catch (e) { alert("Error: " + e); }
    };
    document.getElementById('stopBtn').onclick = () => {
        recorder.stop(); document.getElementById('teacherAudio').pause();
        document.getElementById('startBtn').disabled = false; document.getElementById('stopBtn').disabled = true;
        document.getElementById('status').innerText = "DONE";
    };
    document.getElementById('uploadBtn').onclick = async () => {
        const s = document.getElementById('status'); s.innerText = "UPLOADING...";
        const reader = new FileReader(); 
        reader.readAsDataURL(await fetch(document.getElementById('audioPlayer').src).then(r => r.blob()));
        reader.onloadend = async () => {
            try {
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ audio: reader.result.split(',')[1], className: CLASS_NAME, name: document.getElementById('studentName').value + "_" + BOOK_TITLE + "_" + document.getElementById('lessonSelect').value })});
                s.innerText = "SENT SUCCESS!"; alert("Success!");
            } catch (e) { alert("Fail"); }
        };
    };
</script></body></html>
