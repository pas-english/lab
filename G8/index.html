<!DOCTYPE html><html lang="zh-TW"><head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G8 Recording Lab</title>
    <style>
        :root { --primary: #00ff88; --bg: #1a1d23; --card: #252932; --text: #e0e6ed; }
        body { font-family: "Segoe UI", sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .studio-container { background: var(--card); padding: 30px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-width: 550px; width: 100%; text-align: center; border: 1px solid #333; }
        .admin-title-display { background: linear-gradient(135deg, rgba(0,255,136,0.1) 0%, rgba(0,255,136,0) 100%); border-left: 5px solid var(--primary); color: var(--primary); padding: 15px; border-radius: 8px; font-weight: bold; font-size: 22px; margin-bottom: 20px; text-align: left; }
        .reading-text { background: #2d333d; border: 1px solid #444; padding: 20px; border-radius: 16px; text-align: left; font-size: 18px; line-height: 1.7; color: #fff; margin: 15px 0; min-height: 150px; white-space: pre-wrap; word-break: break-word; }
        .input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        input, select { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #444; background: #1a1d23; color: #fff; font-size: 16px; }
        .visualizer-container { background: #111; border-radius: 12px; height: 80px; margin-bottom: 15px; border: 1px solid #333; }
        canvas { width: 100%; height: 100%; display: block; }
        .btn-box { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn { padding: 16px; border-radius: 14px; border: none; font-weight: bold; font-size: 17px; cursor: pointer; transition: 0.3s; }
        #startBtn { background: #e53e3e; color: #fff; }
        #stopBtn { background: #4a5568; color: #fff; }
        #uploadBtn { background: var(--primary); color: #000; grid-column: span 2; display: none; margin-top: 10px; }
        .status-bar { margin-top: 15px; font-size: 14px; color: var(--primary); font-weight: bold; text-transform: uppercase; }
    </style></head><body><div class="studio-container">
    <h2 style="margin:0 0 5px 0; font-size: 12px; color: #888; text-align: left; letter-spacing: 2px;">PAS ENGLISH LAB</h2>
    <div class="admin-title-display" id="mainTitle"></div>
    <div class="input-row">
        <select id="lessonSelect" onchange="switchLesson()">
            <option value="ch1">Chapter 1</option>
            <option value="ch3">Chapter 3</option>
            <option value="ch5">Chapter 5</option>
        </select>
        <input type="text" id="studentName" placeholder="Enter Your Name">
    </div>
    <div id="lessonText" class="reading-text"></div>
    <div class="visualizer-container"><canvas id="visualizer"></canvas></div>
    <audio id="teacherAudio" preload="auto" crossorigin="anonymous" playsinline></audio>
    <div class="btn-box">
        <button id="startBtn" class="btn">üî¥ START</button>
        <button id="stopBtn" class="btn" disabled>‚èπ STOP</button>
        <button id="uploadBtn" class="btn">üì§ SEND TO TEACHER</button>
    </div>
    <p id="status" class="status-bar">READY</p>
    <audio id="audioPlayer" controls style="display: none; width: 100%; margin-top: 15px;" playsinline></audio>
</div><script>
    const CLASS_NAME = "G8";
    const BOOK_TITLE = "Five Children and It";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyqKj-_QuK1MI7b5hl3sV4p8yjeaAAriBV4I_XbTHUi46gyGBJQoBPCJey_Okbhieaf/exec";
    const lessons = {
        "ch1": { text: "The children were very excited. They were at their new house in the country. It was beautiful. There were trees and flowers everywhere. They wanted to explore and find something interesting. Suddenly, they saw something moving in the sand. It was a Psammead!", audio: "5 children and it - ch1 shadowing.mp3" },
        "ch3": { text: "For their next wish, the children wanted to be very beautiful. But when the wish came true, they didn't recognize each other. They were so beautiful that the servants wouldn't let them into the house! They had to sit outside all day and wait for the wish to end.", audio: "5 children and it - ch3 shadowing.mp3" },
        "ch5": { text: "Anthea and Jane were looking for the Psammead. They wanted to make one last wish. They were worried because the wishes always went wrong. But they needed to help their brother. They found the Psammead near the sand pit. It looked tired but it was ready to listen.", audio: "5 children and it - ch5 shadowing.mp3" }
    };

    document.getElementById('mainTitle').innerText = BOOK_TITLE;
    function switchLesson() {
        const val = document.getElementById('lessonSelect').value;
        document.getElementById('lessonText').innerText = lessons[val].text;
        const tAudio = document.getElementById('teacherAudio');
        tAudio.src = lessons[val].audio; tAudio.load();
    }
    window.onload = switchLesson;
    let recorder, chunks = [], stream, audioCtx, dest, analyser, animationId;

    function drawVisualizer() {
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        function draw() {
            animationId = requestAnimationFrame(draw);
            analyser.getByteTimeDomainData(dataArray);
            ctx.fillStyle = '#111'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 3; ctx.strokeStyle = '#00ff88'; ctx.beginPath();
            let sliceWidth = canvas.width / bufferLength; let x = 0;
            for (let i = 0; i < bufferLength; i++) {
                let v = dataArray[i] / 128.0; let y = v * canvas.height / 2;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                x += sliceWidth;
            }
            ctx.lineTo(canvas.width, canvas.height / 2); ctx.stroke();
        }
        draw();
    }

    document.getElementById('startBtn').onclick = async () => {
        const name = document.getElementById('studentName').value.trim();
        if (!name) return alert("Please enter your name!");
        const teacherAudio = document.getElementById('teacherAudio');
        try {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            
            if (!dest) {
                dest = audioCtx.createMediaStreamDestination();
                analyser = audioCtx.createAnalyser();
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const micSource = audioCtx.createMediaStreamSource(stream);
                micSource.connect(analyser); micSource.connect(dest);
                const tSource = audioCtx.createMediaElementSource(teacherAudio);
                tSource.connect(dest); tSource.connect(audioCtx.destination);
            }
            
            drawVisualizer();
            const options = { mimeType: MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : 'audio/webm' };
            recorder = new MediaRecorder(dest.stream, options);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: options.mimeType });
                const audioURL = URL.createObjectURL(blob);
                const player = document.getElementById('audioPlayer');
                player.src = audioURL;
                player.style.display = 'block';
                player.load();
                document.getElementById('uploadBtn').style.display = 'block';
            };
            chunks = []; teacherAudio.currentTime = 0; teacherAudio.play(); recorder.start();
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('status').innerText = "RECORDING...";
        } catch (err) { alert("Mic Error: " + err); }
    };

    document.getElementById('stopBtn').onclick = () => {
        const teacherAudio = document.getElementById('teacherAudio');
        if(recorder) recorder.stop();
        teacherAudio.pause();
        cancelAnimationFrame(animationId);
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('status').innerText = "STOPPED";
    };

    document.getElementById('uploadBtn').onclick = async () => {
        const statusEl = document.getElementById('status');
        statusEl.innerText = "UPLOADING...";
        const blob = await fetch(document.getElementById('audioPlayer').src).then(r => r.blob());
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = async () => {
            const base64 = reader.result.split(',')[1];
            try {
                await fetch(GAS_URL, {
                    method: 'POST', mode: 'no-cors',
                    body: JSON.stringify({ audio: base64, className: CLASS_NAME, name: document.getElementById('studentName').value + "_" + BOOK_TITLE + "_" + document.getElementById('lessonSelect').value })
                });
                statusEl.innerText = "SENT SUCCESSFULLY!";
                alert("Upload Success!");
                document.getElementById('uploadBtn').style.display = 'none';
            } catch (e) { alert("Upload failed."); }
        };
    };
</script></body></html>
