<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jackie's Reading Lab</title>
    <style>
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background: #f0f4f8; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .classroom { background: white; padding: 30px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); max-width: 650px; width: 100%; text-align: center; }
        .how-to-play { background: #fff9db; border-left: 5px solid #fcc419; padding: 15px; margin-bottom: 20px; border-radius: 12px; text-align: left; font-size: 14px; color: #5c5f66; }
        .reading-text { background: #fff; border: 2px solid #e2e8f0; padding: 25px; border-radius: 15px; margin: 20px 0; text-align: left; line-height: 1.8; font-size: 18px; color: #2d3748; }
        .input-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #4a5568; }
        input[type="text"] { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #edf2f7; box-sizing: border-box; font-size: 16px; }
        .btn { padding: 18px; font-size: 18px; margin: 10px 0; cursor: pointer; border-radius: 15px; border: none; font-weight: bold; width: 100%; transition: 0.2s; }
        #startBtn { background: #e53e3e; color: white; }
        #stopBtn { background: #4a5568; color: white; }
        #uploadBtn { background: #38a169; color: white; }
        .status-badge { margin-top: 15px; padding: 10px; border-radius: 10px; font-weight: bold; background: #edf2f7; }
        audio { width: 100%; margin-top: 10px; }
    </style>
</head>
<body>

<div class="classroom">
    <h1 style="margin:0;">ğŸ™ï¸ Echoing Practice</h1>
    <p id="displayClass" style="color: #718096; margin-top: 5px; font-weight: bold;">Loading Class...</p>

    <div class="how-to-play">
        <h3>ğŸ“– å¦‚ä½•æ“ä½œï¼Ÿ</h3>
        1. è¼¸å…¥å§“åå¾ŒæŒ‰ <b>Start</b> é–‹å§‹ã€‚<br>
        2. è½è€å¸«æœ—è®€ï¼Œä¸¦åœ¨åœé “è™•è·Ÿè®€éŒ„éŸ³ã€‚<br>
        3. å®Œæˆå¾ŒæŒ‰ <b>Stop</b> åœæ­¢ï¼Œæœ€å¾ŒæŒ‰ <b>Send</b> ä¸Šå‚³ã€‚
    </div>

    <div class="input-group">
        <label>ğŸ‘¤ Student Name (å­¸ç”Ÿå§“å):</label>
        <input type="text" id="studentName" placeholder="è«‹è¼¸å…¥å§“å">
    </div>

    <div class="reading-text">
        The next day was very wet. It rained all day and the children could not go to see 
        the Psammead. They stayed at home and wrote letters to their mother. 
        But none of them told her about the Psammead. And the day after that, 
        their Uncle Richard came and took them out, so they didnâ€™t see the Psammead 
        for two days. But Anthea spent a lot of time thinking about what to wish for.
    </div>

    <audio id="teacherAudio" src="https://res.cloudinary.com/dswvflav6/video/upload/v1770704169/ch3_shadowing_spwfot.mp3" preload="auto" crossorigin="anonymous"></audio>

    <button id="startBtn" class="btn">ğŸ”´ Start Reading (é–‹å§‹è·Ÿè®€)</button>
    <button id="stopBtn" class="btn" disabled>â¹ï¸ Stop (åœæ­¢)</button>
    
    <div id="status" class="status-badge">Ready / æº–å‚™å°±ç·’</div>
    
    <audio id="audioPlayer" controls style="display: none;"></audio>
    <button id="uploadBtn" class="btn" style="display: none;">ğŸ“¤ Send (ä¸Šå‚³ç·´ç¿’æª”)</button>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbykzpuqx9r7ol0tjeRYBIq71gRkdnxRz6WkcBjYdtbp-u3tUqfSEDlRmtTrd_bVLKD3AQ/exec";
    
    // ğŸ’¡ æŠ“å–ç¶²å€åƒæ•¸ (ä¾‹å¦‚ ?class=301)
    const urlParams = new URLSearchParams(window.location.search);
    const className = urlParams.get('class') || "General";
    document.getElementById('displayClass').innerText = "Class: " + className;

    let recorder, chunks = [], audioContext, dest, teacherSource, micSource;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const teacherAudio = document.getElementById('teacherAudio');
    const audioPlayer = document.getElementById('audioPlayer');
    const status = document.getElementById('status');
    const studentNameInput = document.getElementById('studentName');

    startBtn.onclick = async () => {
        if (!studentNameInput.value.trim()) { alert("Please enter name!"); return; }
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            dest = audioContext.createMediaStreamDestination();
            const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            micSource = audioContext.createMediaStreamSource(micStream);
            micSource.connect(dest);
            teacherSource = audioContext.createMediaElementSource(teacherAudio);
            teacherSource.connect(dest);
            teacherSource.connect(audioContext.destination);

            recorder = new MediaRecorder(dest.stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                audioPlayer.src = URL.createObjectURL(blob);
                audioPlayer.style.display = 'block';
                uploadBtn.style.display = 'block';
                status.innerText = "Finished! / éŒ„éŸ³å®Œæˆã€‚";
            };

            chunks = [];
            teacherAudio.play();
            recorder.start();
            startBtn.disabled = true;
            stopBtn.disabled = false;
            status.innerText = "ğŸ”´ Recording... / éŒ„éŸ³ä¸­...";
        } catch (err) { alert("Error accessing mic."); }
    };

    stopBtn.onclick = () => {
        recorder.stop();
        teacherAudio.pause();
        teacherAudio.currentTime = 0;
        audioContext.close();
        startBtn.disabled = false;
        stopBtn.disabled = true;
    };

    uploadBtn.onclick = async () => {
        const name = studentNameInput.value.trim();
        status.innerText = "ğŸš€ Uploading... / ä¸Šå‚³ä¸­...";
        uploadBtn.disabled = true;
        const blob = await fetch(audioPlayer.src).then(r => r.blob());
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = async () => {
            const base64Data = reader.result.split(',')[1];
            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        audio: base64Data,
                        className: className,
                        name: name + "_" + new Date().getTime()
                    })
                });
                status.innerText = "âœ… Success! / ä¸Šå‚³æˆåŠŸï¼";
                uploadBtn.style.display = 'none';
            } catch (e) { 
                status.innerText = "âŒ Failed. / å¤±æ•—ã€‚";
                uploadBtn.disabled = false;
            }
        };
    };
</script>

</body>
</html>
