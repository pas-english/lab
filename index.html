<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jackie's Reading Lab</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f4f8; display: flex; justify-content: center; padding: 15px; margin: 0; }
        .classroom { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 600px; width: 100%; text-align: center; box-sizing: border-box; }
        
        .media-box { width: 100%; margin-bottom: 20px; border-radius: 15px; overflow: hidden; border: 2px solid #e2e8f0; }
        .media-box img { width: 100%; height: auto; display: block; }

        .how-to-play { 
            background: #fff9db; 
            border-left: 5px solid #fcc419; 
            padding: 15px; 
            margin-bottom: 20px; 
            border-radius: 12px; 
            text-align: left; 
            font-size: 14px; 
            color: #5c5f66; 
            line-height: 1.8; 
        }
        
        .reading-text { 
            background: #fff; 
            border: 2px solid #e2e8f0; 
            padding: 20px; 
            border-radius: 15px; 
            margin: 15px 0; 
            text-align: left; 
            line-height: 1.7; 
            font-size: 18px; 
            color: #2d3748; 
            min-height: 120px; 
            height: auto; 
            word-wrap: break-word; 
        }
        
        .input-group { margin-bottom: 15px; text-align: left; display: flex; gap: 10px; flex-wrap: wrap; }
        .input-item { flex: 1; min-width: 150px; }
        
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; background: #f8fafc; box-sizing: border-box; }
        .btn { padding: 16px; font-size: 18px; margin: 8px 0; cursor: pointer; border-radius: 12px; border: none; font-weight: bold; width: 100%; transition: 0.2s; }
        
        #startBtn { background: #e53e3e; color: white; }
        #stopBtn { background: #4a5568; color: white; }
        #uploadBtn { background: #38a169; color: white; }
        
        .status { margin-top: 10px; font-weight: bold; color: #2d3748; font-size: 15px; }
        audio { width: 100%; margin-top: 10px; }
        #playerContainer { background: #edf2f7; padding: 15px; border-radius: 15px; margin-top: 10px; display: none; text-align: left; }
    </style>
</head>
<body>

<div class="classroom">
    <h1 style="margin:0; font-size: 26px;">ğŸ™ï¸ Ch3 ç¹ªæœ¬ç·´ç¿’</h1>
    <p style="color: #718096; margin: 5px 0 20px 0; font-weight: bold;">Jackie's English Reading Lab</p>

    <div class="media-box">
        <img src="https://docs.google.com/uc?export=download&id=1CpQ-jRVCk14qqb5F8gN4LeAckx2ybBhe" alt="Story Illustration">
    </div>

    <div class="how-to-play">
        <b>ğŸ’¡ æ“ä½œæµç¨‹ï¼š</b><br>
        1. é¸æ“‡ç­ç´šä¸¦è¼¸å…¥å§“åã€‚<br>
        2. æŒ‰ <b>Start Reading</b> é–‹å§‹éŒ„éŸ³ã€‚<br>
        3. è«‹è·Ÿè‘—è€å¸«è®€ä¸€æ®µã€ä½ å°±è®€ä¸€æ®µã€‚<br>
        4. è®€å®Œå¾ŒæŒ‰ <b>Stop</b> åœæ­¢éŒ„éŸ³ã€‚<br>
        5. æœ€å¾ŒæŒ‰ <b>Send</b> ä¸Šå‚³çµ¦è€å¸«ã€‚
    </div>

    <div class="input-group">
        <div class="input-item">
            <select id="className">
                <option value="General">-- é¸æ“‡ç­ç´š --</option>
                <optgroup label="åœ‹ä¸­éƒ¨">
                    <option value="G7">G7</option><option value="G8" selected>G8</option><option value="G9">G9</option>
                </optgroup>
            </select>
        </div>
        <div class="input-item">
            <input type="text" id="studentName" placeholder="å­¸ç”Ÿå§“å">
        </div>
    </div>

    <div class="reading-text">
        The next day was very wet. It rained all day and the children could not go to see the Psammead. They stayed at home and wrote letters to their mother. But none of them told her about the Psammead. And the day after that, their Uncle Richard came and took them out, so they didnâ€™t see the Psammead for two days. But Anthea spent a lot of time thinking about what to wish for.
    </div>

    <audio id="teacherAudio" src="https://res.cloudinary.com/dswvflav6/video/upload/v1770704169/ch3_shadowing_spwfot.mp3" preload="auto" crossorigin="anonymous"></audio>

    <button id="startBtn" class="btn">ğŸ”´ Start Reading (é–‹å§‹è·Ÿè®€)</button>
    <button id="stopBtn" class="btn" disabled>â¹ï¸ Stop (åœæ­¢éŒ„éŸ³)</button>
    
    <div id="status" class="status">Ready / æº–å‚™å°±ç·’</div>
    
    <div id="playerContainer">
        <p style="margin:0 0 10px 0; font-size:14px; font-weight:bold; color: #4a5568;">ğŸ§ ä½ çš„ç·´ç¿’éŒ„éŸ³ï¼š</p>
        <audio id="audioPlayer" controls></audio>
    </div>
    
    <button id="uploadBtn" class="btn" style="display: none;">ğŸ“¤ Send (å‚³é€çµ¦è€å¸«)</button>
</div>

<script>
    // å·²æ›´æ–°ç‚ºæ‚¨å‰›æ‰æä¾›çš„ GAS ç¶²å€
    const GAS_URL = "https://script.google.com/macros/s/AKfycbznQwq6elMdN5qUyApqv2aeIWyWS2MiZBaU-I1NSt8f-eBpYQBa61VFI0jUtKKUGwAbIw/exec"; 

    let recorder, chunks = [], audioContext, dest, teacherSource, activeStream;
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const teacherAudio = document.getElementById('teacherAudio');
    const audioPlayer = document.getElementById('audioPlayer');
    const status = document.getElementById('status');
    const studentNameInput = document.getElementById('studentName');

    startBtn.onclick = async () => {
        if (!studentNameInput.value.trim()) { 
            alert("ğŸ’¡ Jackie è€å¸«æé†’ï¼šåˆ¥å¿˜äº†å…ˆè¼¸å…¥å§“åå–”ï¼"); 
            return; 
        }
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            dest = audioContext.createMediaStreamDestination();
            activeStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const micSource = audioContext.createMediaStreamSource(activeStream);
            micSource.connect(dest);
            
            teacherSource = audioContext.createMediaElementSource(teacherAudio);
            teacherSource.connect(dest);
            teacherSource.connect(audioContext.destination);

            recorder = new MediaRecorder(dest.stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                audioPlayer.src = URL.createObjectURL(blob);
                document.getElementById('playerContainer').style.display = 'block';
                uploadBtn.style.display = 'block';
                status.innerText = "ğŸ‰ éŒ„è£½å®Œæˆï¼é»æ’­æ”¾éˆ•è©¦è½ï¼Œæˆ–æŒ‰ Send ä¸Šå‚³ã€‚";
                
                if (activeStream) {
                    activeStream.getTracks().forEach(track => track.stop());
                }
            };

            chunks = [];
            teacherAudio.play();
            recorder.start();
            startBtn.disabled = true; stopBtn.disabled = false;
            status.innerText = "ğŸ”´ æ­£åœ¨éŒ„éŸ³ä¸­ï¼Œè·Ÿè‘—è€å¸«è®€...";
        } catch (err) { alert("éº¥å…‹é¢¨é–‹å•Ÿå¤±æ•—ï¼Œè«‹ç¢ºèªæ˜¯å¦å…è¨±æ¬Šé™ï¼"); }
    };

    stopBtn.onclick = () => {
        if (recorder && recorder.state !== "inactive") {
            recorder.stop();
            teacherAudio.pause(); teacherAudio.currentTime = 0;
            startBtn.disabled = false; stopBtn.disabled = true;
        }
    };

    uploadBtn.onclick = async () => {
        status.innerText = "ğŸš€ æ­£åœ¨å‚³é€æª”æ¡ˆçµ¦è€å¸«...";
        uploadBtn.disabled = true;
        const blob = await fetch(audioPlayer.src).then(r => r.blob());
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = async () => {
            const base64Data = reader.result.split(',')[1];
            try {
                // ä½¿ç”¨ no-cors ç¢ºä¿è·¨ç¶²åŸŸå‚³é€æˆåŠŸ
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        audio: base64Data,
                        className: document.getElementById('className').value,
                        name: studentNameInput.value.trim()
                    })
                });
                status.innerText = "âœ… ä¸Šå‚³æˆåŠŸï¼Jackie è€å¸«æ”¶åˆ°äº†ã€‚";
                uploadBtn.style.display = 'none';
            } catch (e) { 
                status.innerText = "âŒ å‚³é€å¤±æ•—ï¼Œè«‹å†æŒ‰ä¸€æ¬¡ Send"; 
                uploadBtn.disabled = false; 
            }
        };
    };
</script>

</body>
</html>
