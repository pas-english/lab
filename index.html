<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jackie's Recording Studio</title>
    <style>
        :root { --primary: #00ff88; --bg: #1a1d23; --card: #252932; --text: #e0e6ed; }
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 20px; margin: 0; }
        
        .studio-container { background: var(--card); padding: 30px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-width: 600px; width: 100%; text-align: center; border: 1px solid #333; }
        
        .media-box { width: 100%; border-radius: 16px; overflow: hidden; margin-bottom: 20px; border: 2px solid #3d4451; background: #000; }
        .media-box img { width: 100%; display: block; opacity: 0.9; }

        /* Â∞àÊ•≠Ê≥¢ÂΩ¢È°ØÁ§∫ÂçÄ */
        .visualizer-container { 
            background: #000; height: 100px; width: 100%; border-radius: 12px; margin-bottom: 20px; 
            position: relative; border: 1px solid var(--primary); overflow: hidden;
        }
        canvas { width: 100%; height: 100%; }

        .reading-text { 
            background: #2d333d; border: 1px solid #444; padding: 20px; border-radius: 16px; 
            text-align: left; font-size: 19px; line-height: 1.8; color: #fff; margin-bottom: 20px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.2);
        }

        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input, select { 
            flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #444; 
            background: #1a1d23; color: #fff; font-size: 16px; outline: none;
        }
        select:focus, input:focus { border-color: var(--primary); }

        .btn-box { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn { 
            padding: 16px; border-radius: 14px; border: none; font-weight: bold; font-size: 17px; 
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        
        #startBtn { background: #e53e3e; color: #fff; }
        #startBtn:hover { background: #ff4d4d; box-shadow: 0 0 15px rgba(229, 62, 62, 0.4); }
        #stopBtn { background: #4a5568; color: #fff; }
        #uploadBtn { background: var(--primary); color: #000; grid-column: span 2; display: none; margin-top: 10px; }
        
        .status-bar { margin-top: 15px; font-size: 14px; color: var(--primary); letter-spacing: 1px; }
        audio { width: 100%; margin-top: 15px; filter: invert(100%) hue-rotate(180deg); opacity: 0.7; }
        
        #playerLabel { text-align: left; font-size: 14px; margin: 15px 0 5px; color: #888; display: none; }
    </style>
</head>
<body>

<div class="studio-container">
    <h1 style="margin:0; font-size: 24px; color: var(--primary);">STUDIO MODE</h1>
    <p style="color: #888; margin: 5px 0 20px 0; font-size: 12px; text-transform: uppercase;">Jackie's English Reading Lab</p>

    <div class="media-box">
        <img src="https://docs.google.com/uc?export=download&id=1CpQ-jRVCk14qqb5F8gN4LeAckx2ybBhe">
    </div>

    <div class="input-group">
        <select id="className">
            <option value="G8">CLASS G8</option>
            <option value="G7">CLASS G7</option>
            <option value="G9">CLASS G9</option>
        </select>
        <input type="text" id="studentName" placeholder="STUDENT NAME">
    </div>

    <div class="visualizer-container">
        <canvas id="visualizer"></canvas>
    </div>

    <div class="reading-text">
        The next day was very wet. It rained all day and the children could not go to see the Psammead. They stayed at home and wrote letters to their mother. But none of them told her about the Psammead. And the day after that, their Uncle Richard came and took them out, so they didn‚Äôt see the Psammead for two days. But Anthea spent a lot of time thinking about what to wish for.
    </div>

    <audio id="teacherAudio" src="https://res.cloudinary.com/dswvflav6/video/upload/v1770704169/ch3_shadowing_spwfot.mp3" preload="auto" crossorigin="anonymous"></audio>

    <div class="btn-box">
        <button id="startBtn" class="btn">‚è∫ START</button>
        <button id="stopBtn" class="btn" disabled>‚èπ STOP</button>
        <button id="uploadBtn" class="btn">üì§ SEND TO JACKIE</button>
    </div>
    
    <p id="status" class="status-bar">SYSTEM READY</p>
    
    <div id="playerLabel">PREVIEW RECORDING:</div>
    <audio id="audioPlayer" controls style="display: none;"></audio>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbznQwq6elMdN5qUyApqv2aeIWyWS2MiZBaU-I1NSt8f-eBpYQBa61VFI0jUtKKUGwAbIw/exec"; 

    let recorder, chunks = [], audioContext, dest, teacherSource, activeStream, analyser, dataArray, animationId;
    
    const canvas = document.getElementById('visualizer');
    const canvasCtx = canvas.getContext('2d');

    // Áπ™Ë£ΩÊ≥¢ÂΩ¢Âúñ
    function draw() {
        animationId = requestAnimationFrame(draw);
        analyser.getByteTimeDomainData(dataArray);
        canvasCtx.fillStyle = '#000';
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        canvasCtx.lineWidth = 2;
        canvasCtx.strokeStyle = '#00ff88';
        canvasCtx.beginPath();
        let sliceWidth = canvas.width * 1.0 / analyser.frequencyBinCount;
        let x = 0;
        for(let i = 0; i < analyser.frequencyBinCount; i++) {
            let v = dataArray[i] / 128.0;
            let y = v * canvas.height / 2;
            if(i === 0) canvasCtx.moveTo(x, y);
            else canvasCtx.lineTo(x, y);
            x += sliceWidth;
        }
        canvasCtx.lineTo(canvas.width, canvas.height / 2);
        canvasCtx.stroke();
    }

    document.getElementById('startBtn').onclick = async () => {
        if (!document.getElementById('studentName').value.trim()) return alert("PLEASE ENTER YOUR NAME");
        
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            dest = audioContext.createMediaStreamDestination();
            activeStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // Ë®≠ÂÆöÂàÜÊûêÂÑÄ (ÂÅöÊ≥¢ÂΩ¢ÂúñÁî®)
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            const micSource = audioContext.createMediaStreamSource(activeStream);
            micSource.connect(analyser); // Êé•Âà∞ÂàÜÊûêÂÑÄ
            micSource.connect(dest);
            
            const teacherAudio = document.getElementById('teacherAudio');
            teacherSource = audioContext.createMediaElementSource(teacherAudio);
            teacherSource.connect(dest);
            teacherSource.connect(audioContext.destination);

            recorder = new MediaRecorder(dest.stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                const player = document.getElementById('audioPlayer');
                player.src = URL.createObjectURL(blob);
                player.style.display = 'block';
                document.getElementById('playerLabel').style.display = 'block';
                document.getElementById('uploadBtn').style.display = 'flex';
                document.getElementById('status').innerText = "RECORDING FINISHED";
                cancelAnimationFrame(animationId);
            };

            chunks = [];
            teacherAudio.play();
            recorder.start();
            draw(); // ÈñãÂßãÁï´Âúñ
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('status').innerText = "‚óè RECORDING IN PROGRESS";
        } catch (err) { alert("Mic Error!"); }
    };

    document.getElementById('stopBtn').onclick = () => {
        recorder.stop();
        document.getElementById('teacherAudio').pause();
        document.getElementById('teacherAudio').currentTime = 0;
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        if (activeStream) activeStream.getTracks().forEach(track => track.stop());
    };

    document.getElementById('uploadBtn').onclick = async () => {
        document.getElementById('status').innerText = "UPLOADING TO CLOUD...";
        document.getElementById('uploadBtn').disabled = true;
        const blob = await fetch(document.getElementById('audioPlayer').src).then(r => r.blob());
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = async () => {
            const base64 = reader.result.split(',')[1];
            await fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    audio: base64,
                    className: document.getElementById('className').value,
                    name: document.getElementById('studentName').value
                })
            });
            document.getElementById('status').innerText = "MISSION ACCOMPLISHED!";
            document.getElementById('uploadBtn').style.display = 'none';
        };
    };
</script>
</body>
</html>
