<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jackie's Reading Lab</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f4f8; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .classroom { background: white; padding: 30px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); max-width: 600px; width: 100%; text-align: center; }
        /* ğŸŒŸ é€™æ˜¯æ‰¾å›ä¾†çš„é»ƒè‰²æç¤ºæ¡†æ¨£å¼ */
        .how-to-play { background: #fff9db; border-left: 5px solid #fcc419; padding: 15px; margin-bottom: 20px; border-radius: 12px; text-align: left; font-size: 14px; color: #5c5f66; line-height: 1.6; }
        .reading-text { background: #fff; border: 2px solid #e2e8f0; padding: 25px; border-radius: 15px; margin: 20px 0; text-align: left; line-height: 1.8; font-size: 19px; color: #2d3748; }
        .input-group { margin-bottom: 15px; text-align: left; display: flex; gap: 10px; }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; background: #f8fafc; }
        .btn { padding: 18px; font-size: 18px; margin: 10px 0; cursor: pointer; border-radius: 15px; border: none; font-weight: bold; width: 100%; transition: 0.2s; }
        #startBtn { background: #e53e3e; color: white; }
        #stopBtn { background: #4a5568; color: white; }
        #uploadBtn { background: #38a169; color: white; }
        .status { margin-top: 15px; font-weight: bold; color: #2d3748; min-height: 24px; }
    </style>
</head>
<body>

<div class="classroom">
    <h1 style="margin:0;">ğŸ™ï¸ Echoing Practice</h1>
    <p style="color: #718096; margin-bottom: 20px;">Jackie's English Reading Lab</p>

    <div class="how-to-play">
        <b>ğŸ’¡ æ“ä½œæµç¨‹ï¼š</b><br>
        1. é¸æ“‡ç­ç´šä¸¦è¼¸å…¥å§“åã€‚<br>
        2. æŒ‰ <b>Start</b> é–‹å§‹ï¼Œè½è€å¸«è®€ä¸€æ®µã€ä½ å°±è·Ÿè‘—è®€ä¸€æ®µã€‚<br>
        3. å®Œç•¢å¾ŒæŒ‰ <b>Stop</b>ï¼Œæœ€å¾ŒæŒ‰ <b>Send</b> ä¸Šå‚³ã€‚
    </div>

    <div class="input-group">
        <select id="className">
            <option value="General">-- é¸æ“‡ç­ç´š --</option>
            <option value="G7">G7</option><option value="G8">G8</option><option value="G9">G9</option>
            <option value="1A">1A</option><option value="1B">1B</option><option value="1C">1C</option>
        </select>
        <input type="text" id="studentName" placeholder="å­¸ç”Ÿå§“å">
    </div>

    <div class="reading-text">
        The next day was very wet. It rained all day and the children could not go to see 
        the Psammead. They stayed at home and wrote letters to their mother. 
        But none of them told her about the Psammead.
    </div>

    <audio id="teacherAudio" src="https://res.cloudinary.com/dswvflav6/video/upload/v1770704169/ch3_shadowing_spwfot.mp3" preload="auto" crossorigin="anonymous"></audio>

    <button id="startBtn" class="btn">ğŸ”´ Start Reading (é–‹å§‹è·Ÿè®€)</button>
    <button id="stopBtn" class="btn" disabled>â¹ï¸ Stop (åœæ­¢)</button>
    
    <div id="status" class="status">Ready / æº–å‚™å°±ç·’</div>
    
    <audio id="audioPlayer" controls style="display: none; width: 100%; margin-top: 10px;"></audio>
    <button id="uploadBtn" class="btn" style="display: none;">ğŸ“¤ Send (å‚³é€çµ¦è€å¸«)</button>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwULwx5HJzU0anAPGaxYSwDLYUPD4W0IyfXteVi8uSKtsoNuAdu9A-AeMZYcrJp81z0lg/exec"; 

    let recorder, chunks = [], audioContext, dest, teacherSource;
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const teacherAudio = document.getElementById('teacherAudio');
    const audioPlayer = document.getElementById('audioPlayer');
    const status = document.getElementById('status');
    const studentNameInput = document.getElementById('studentName');

    startBtn.onclick = async () => {
        // ğŸŒŸ å½ˆå‡ºå¼æº«é¦¨æé†’
        if (!studentNameInput.value.trim()) { 
            alert("ğŸ’¡ Jackie è€å¸«æé†’ï¼š\n\nåˆ¥å¿˜äº†å…ˆè¼¸å…¥ä½ çš„ã€å§“åã€å–”ï¼"); 
            return; 
        }
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            dest = audioContext.createMediaStreamDestination();
            const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const micSource = audioContext.createMediaStreamSource(micStream);
            micSource.connect(dest);
            
            teacherSource = audioContext.createMediaElementSource(teacherAudio);
            teacherSource.connect(dest);
            teacherSource.connect(audioContext.destination);

            recorder = new MediaRecorder(dest.stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                audioPlayer.src = URL.createObjectURL(blob);
                audioPlayer.style.display = 'block';
                uploadBtn.style.display = 'block';
                status.innerText = "ğŸ‰ éŒ„éŸ³å®Œæˆï¼è«‹æŒ‰ Send ä¸Šå‚³ã€‚";
            };
            chunks = [];
            teacherAudio.play();
            recorder.start();
            startBtn.disabled = true; stopBtn.disabled = false;
            status.innerText = "ğŸ”´ æ­£åœ¨éŒ„éŸ³ä¸­ï¼ŒåŠ æ²¹ï¼è·Ÿè‘—è€å¸«è®€...";
        } catch (err) { alert("éº¥å…‹é¢¨é–‹å•Ÿå¤±æ•—ï¼Œè«‹å…è¨±æ¬Šé™ï¼"); }
    };

    stopBtn.onclick = () => {
        recorder.stop();
        teacherAudio.pause(); teacherAudio.currentTime = 0;
        audioContext.close();
        startBtn.disabled = false; stopBtn.disabled = true;
    };

    uploadBtn.onclick = async () => {
        status.innerText = "ğŸš€ æ­£åœ¨å‚³é€æª”æ¡ˆçµ¦è€å¸«...";
        uploadBtn.disabled = true;
        const blob = await fetch(audioPlayer.src).then(r => r.blob());
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = async () => {
            const base64Data = reader.result.split(',')[1];
            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        audio: base64Data,
                        className: document.getElementById('className').value,
                        name: studentNameInput.value.trim() + "_" + new Date().getTime()
                    })
                });
                status.innerText = "âœ… ä¸Šå‚³æˆåŠŸï¼Jackie è€å¸«æ”¶åˆ°äº†ã€‚";
                uploadBtn.style.display = 'none';
            } catch (e) { status.innerText = "âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚"; uploadBtn.disabled = false; }
        };
    };
</script>

</body>
</html>
