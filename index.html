<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jackie's Lab</title>
    <style>
        body { font-family: sans-serif; background: #f0f4f8; padding: 20px; display: flex; justify-content: center; }
        .box { background: white; padding: 20px; border-radius: 15px; max-width: 500px; width: 100%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        img { width: 100%; border-radius: 10px; margin-bottom: 15px; display: none; }
        .text { background: #f8fafc; padding: 15px; border-radius: 10px; margin: 15px 0; line-height: 1.6; font-size: 18px; }
        .btn { width: 100%; padding: 15px; margin: 5px 0; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        #startBtn { background: #e53e3e; color: white; }
        #stopBtn { background: #4a5568; color: white; }
        #uploadBtn { background: #38a169; color: white; display: none; }
    </style>
</head>
<body>
<div class="box">
    <h2 id="title">è¼‰å…¥ä¸­...</h2>
    <img id="image" src="">
    <input type="text" id="name" placeholder="å­¸ç”Ÿå§“å" style="width:100%; padding:10px; margin-bottom:10px; box-sizing:border-box;">
    <div id="text" class="text">æ­£åœ¨åŒæ­¥è³‡æ–™...</div>
    <audio id="teacherAudio"></audio>
    <button id="startBtn" class="btn">ğŸ”´ é–‹å§‹ç·´ç¿’</button>
    <button id="stopBtn" class="btn" disabled>â¹ï¸ åœæ­¢</button>
    <audio id="player" controls style="width:100%; margin-top:15px; display:none;"></audio>
    <button id="uploadBtn" class="btn">ğŸ“¤ å‚³é€çµ¦è€å¸«</button>
    <p id="status" style="text-align:center; font-weight:bold;"></p>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbznQwq6elMdN5qUyApqv2aeIWyWS2MiZBaU-I1NSt8f-eBpYQBa61VFI0jUtKKUGwAbIw/exec";

    async function init() {
        try {
            const r = await fetch(GAS_URL);
            const d = await r.json();
            document.getElementById('title').innerText = d.title;
            document.getElementById('text').innerText = d.text;
            document.getElementById('teacherAudio').src = d.audio;
            if(d.media_url) {
                const img = document.getElementById('image');
                img.src = d.media_url;
                img.style.display = 'block';
            }
        } catch (e) { document.getElementById('text').innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"; }
    }
    init();

    let rec, chunks = [];
    const teacherAudio = document.getElementById('teacherAudio');

    document.getElementById('startBtn').onclick = async () => {
        if(!document.getElementById('name').value) return alert("è«‹è¼¸å…¥å§“å");
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const ctx = new AudioContext();
        const dest = ctx.createMediaStreamDestination();
        ctx.createMediaStreamSource(stream).connect(dest);
        ctx.createMediaElementSource(teacherAudio).connect(dest);
        dest.connect(ctx.destination);
        
        rec = new MediaRecorder(dest.stream);
        rec.ondataavailable = e => chunks.push(e.data);
        rec.onstop = () => {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            const p = document.getElementById('player');
            p.src = URL.createObjectURL(blob);
            p.style.display = 'block';
            document.getElementById('uploadBtn').style.display = 'block';
        };
        chunks = [];
        teacherAudio.play();
        rec.start();
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
    };

    document.getElementById('stopBtn').onclick = () => {
        rec.stop();
        teacherAudio.pause();
        teacherAudio.currentTime = 0;
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
    };

    document.getElementById('uploadBtn').onclick = async () => {
        document.getElementById('status').innerText = "ä¸Šå‚³ä¸­...";
        const blob = await fetch(document.getElementById('player').src).then(r => r.blob());
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = async () => {
            await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ audio: reader.result.split(',')[1], name: document.getElementById('name').value, className: 'G8' }) });
            document.getElementById('status').innerText = "âœ… ä¸Šå‚³æˆåŠŸï¼";
            document.getElementById('uploadBtn').style.display = 'none';
        };
    };
</script>
</body>
</html>
