<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jackie's Reading Lab</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f4f8; display: flex; justify-content: center; padding: 15px; margin: 0; }
        .classroom { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 600px; width: 100%; text-align: center; box-sizing: border-box; }
        .how-to-play { background: #fff9db; border-left: 5px solid #fcc419; padding: 15px; margin-bottom: 20px; border-radius: 12px; text-align: left; font-size: 14px; color: #5c5f66; line-height: 1.8; }
        #mediaContainer { width: 100%; margin-bottom: 15px; border-radius: 15px; overflow: hidden; display: none; }
        #mediaContainer img { width: 100%; height: auto; border: 2px solid #e2e8f0; border-radius: 10px; display: block; }
        .reading-text { background: #fff; border: 2px solid #e2e8f0; padding: 20px; border-radius: 15px; margin: 15px 0; text-align: left; line-height: 1.7; font-size: 19px; color: #2d3748; min-height: 60px; white-space: pre-wrap; }
        .input-group { margin-bottom: 15px; text-align: left; display: flex; gap: 10px; flex-wrap: wrap; }
        .input-item { flex: 1; min-width: 140px; }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; background: #f8fafc; box-sizing: border-box; }
        .btn { padding: 18px; font-size: 18px; margin: 8px 0; cursor: pointer; border-radius: 12px; border: none; font-weight: bold; width: 100%; transition: 0.3s; }
        #startBtn { background: #e53e3e; color: white; }
        #stopBtn { background: #4a5568; color: white; }
        #uploadBtn { background: #38a169; color: white; }
        .status { margin-top: 10px; font-weight: bold; color: #2d3748; }
        #playerContainer { background: #edf2f7; padding: 15px; border-radius: 15px; margin-top: 10px; display: none; }
        .btn:active { opacity: 0.7; transform: scale(0.98); }
        .btn:disabled { background: #cbd5e0 !important; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="classroom">
    <h1 id="lessonTitle">ğŸ« Jackie's Classroom</h1>
    <p style="color: #718096; margin: 5px 0 20px 0; font-weight: bold;">English Echoing Lab</p>

    <div class="how-to-play">
        <b>ğŸ’¡ ç·´ç¿’æ­¥é©Ÿï¼š</b><br>
        1. è¼¸å…¥å§“åã€‚ 2. æŒ‰ <b>Start</b> è½è€å¸«è®€ã€‚ 3. åœ¨ç©ºç™½è™•æ¨¡ä»¿ã€‚ 4. è®€å®ŒæŒ‰ <b>Stop</b>ã€‚ 5. æŒ‰ <b>Send</b>ã€‚
    </div>

    <div id="mediaContainer"></div>

    <div class="input-group">
        <div class="input-item">
            <select id="className">
                <option value="General">-- ç­ç´š --</option>
                <option value="1A">1A</option><option value="G7">G7</option><option value="G8">G8</option>
            </select>
        </div>
        <div class="input-item">
            <input type="text" id="studentName" placeholder="å­¸ç”Ÿå§“å">
        </div>
    </div>

    <div class="reading-text" id="lessonText">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™ï¼Œè«‹ç¨å€™...</div>

    <audio id="teacherAudio" preload="auto" crossorigin="anonymous"></audio>

    <button id="startBtn" class="btn">ğŸ”´ Start Reading</button>
    <button id="stopBtn" class="btn" disabled>â¹ï¸ Stop</button>
    
    <div id="status" class="status">Ready</div>
    
    <div id="playerContainer">
        <p style="margin:0 0 10px 0; font-size:14px; font-weight:bold;">ğŸ§ è©¦è½ä½ çš„éŒ„éŸ³ï¼š</p>
        <audio id="audioPlayer" controls style="width: 100%;"></audio>
    </div>
    
    <button id="uploadBtn" class="btn" style="display: none;">ğŸ“¤ Send to Jackie</button>
</div>

<script>
    // ç¢ºå®šçš„ GAS ç¶²å€
    const GAS_URL = "https://script.google.com/macros/s/AKfycbznQwq6elMdN5qUyApqv2aeIWyWS2MiZBaU-I1NSt8f-eBpYQBa61VFI0jUtKKUGwAbIw/exec"; 

    // çµ‚æ¥µä¿®æ­£ï¼šJSONP å›å‘¼å‡½å¼
    function handleResponse(data) {
        document.getElementById('lessonTitle').innerText = data.title || "Echoing Practice";
        document.getElementById('lessonText').innerText = data.text || "ç›®å‰æ²’æœ‰èª²æ–‡å…§å®¹";
        document.getElementById('teacherAudio').src = data.audio;
        
        const container = document.getElementById('mediaContainer');
        if (data.media_type === "image" && data.media_url) {
            container.innerHTML = `<img src="${data.media_url}" alt="Book Image">`;
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    }

    // é€é script æ¨™ç±¤è¼‰å…¥è³‡æ–™ (ç¹é CORS)
    const script = document.createElement('script');
    script.src = GAS_URL + "?callback=handleResponse";
    document.body.appendChild(script);

    let recorder, chunks = [], activeStream;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const teacherAudio = document.getElementById('teacherAudio');
    const audioPlayer = document.getElementById('audioPlayer');
    const status = document.getElementById('status');

    startBtn.onclick = async () => {
        if (!document.getElementById('studentName').value.trim()) { alert("è«‹è¼¸å…¥å§“åï¼"); return; }
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            activeStream = stream;
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const dest = audioCtx.createMediaStreamDestination();
            const micSource = audioCtx.createMediaStreamSource(stream);
            micSource.connect(dest);
            const teacherSource = audioCtx.createMediaElementSource(teacherAudio);
            teacherSource.connect(dest);
            teacherSource.connect(audioCtx.destination);
            
            recorder = new MediaRecorder(dest.stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                audioPlayer.src = URL.createObjectURL(blob);
                document.getElementById('playerContainer').style.display = 'block';
                uploadBtn.style.display = 'block';
                status.innerText = "éŒ„éŸ³å®Œæˆï¼å¯è©¦è½ã€‚";
                activeStream.getTracks().forEach(track => track.stop());
            };
            chunks = [];
            teacherAudio.play();
            recorder.start();
            startBtn.disabled = true; stopBtn.disabled = false;
            status.innerText = "ğŸ”´ æ­£åœ¨éŒ„éŸ³ä¸­...";
        } catch (err) { alert("éº¥å…‹é¢¨å­˜å–å¤±æ•—ã€‚"); }
    };

    stopBtn.onclick = () => {
        if(recorder && recorder.state !== "inactive") recorder.stop();
        teacherAudio.pause(); teacherAudio.currentTime = 0;
        startBtn.disabled = false; stopBtn.disabled = true;
    };

    uploadBtn.onclick = async () => {
        status.innerText = "ğŸš€ å‚³é€ä¸­...";
        uploadBtn.disabled = true;
        const blob = await fetch(audioPlayer.src).then(r => r.blob());
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = async () => {
            const base64Data = reader.result.split(',')[1];
            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        audio: base64Data,
                        className: document.getElementById('className').value,
                        name: document.getElementById('studentName').value
                    })
                });
                status.innerText = "âœ… ä¸Šå‚³æˆåŠŸï¼";
                uploadBtn.style.display = 'none';
            } catch (e) { 
                status.innerText = "âŒ å¤±æ•—ï¼Œè«‹å†æŒ‰ä¸€æ¬¡ Send"; 
                uploadBtn.disabled = false; 
            }
        };
    };
</script>
</body>
</html>
