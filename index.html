<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jackie's Reading Lab</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f4f8; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .classroom { background: white; padding: 30px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); max-width: 600px; width: 100%; text-align: center; }
        .how-to-play { background: #fff9db; border-left: 5px solid #fcc419; padding: 15px; margin-bottom: 20px; border-radius: 12px; text-align: left; font-size: 14px; color: #5c5f66; line-height: 1.6; }
        .reading-text { background: #fff; border: 2px solid #e2e8f0; padding: 25px; border-radius: 15px; margin: 20px 0; text-align: left; line-height: 1.8; font-size: 19px; color: #2d3748; }
        .input-group { margin-bottom: 15px; text-align: left; display: flex; gap: 10px; }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; background: #f8fafc; }
        .btn { padding: 18px; font-size: 18px; margin: 10px 0; cursor: pointer; border-radius: 15px; border: none; font-weight: bold; width: 100%; transition: 0.2s; }
        #startBtn { background: #e53e3e; color: white; }
        #stopBtn { background: #4a5568; color: white; }
        #uploadBtn { background: #38a169; color: white; }
        .status { margin-top: 15px; font-weight: bold; color: #2d3748; min-height: 24px; }
        audio { width: 100%; margin-top: 10px; border-radius: 10px; }
    </style>
</head>
<body>

<div class="classroom">
    <h1 style="margin:0;">ğŸ™ï¸ Echoing Practice</h1>
    <p style="color: #718096; margin-bottom: 20px;">Jackie's English Reading Lab</p>

    <div class="how-to-play">
        <b>ğŸ’¡ æ“ä½œæµç¨‹ï¼š</b><br>
        1. é¸æ“‡ç­ç´šä¸¦è¼¸å…¥å§“åã€‚<br>
        2. æŒ‰ <b>Start</b> é–‹å§‹ï¼Œè½ä¸€æ®µè®€ä¸€æ®µã€‚<br>
        3. å®Œç•¢æŒ‰ <b>Stop</b>ï¼Œå¯å…ˆè©¦è½ï¼Œå†æŒ‰ <b>Send</b> ä¸Šå‚³ã€‚
    </div>

    <div class="input-group">
        <select id="className">
            <option value="General">-- é¸æ“‡ç­ç´š --</option>
            <option value="G7">G7</option><option value="G8">G8</option><option value="G9">G9</option>
            <option value="1A">1A</option><option value="1B">1B</option>
        </select>
        <input type="text" id="studentName" placeholder="è«‹è¼¸å…¥å§“å">
    </div>

    <div class="reading-text">
        The next day was very wet. It rained all day and the children could not go to see 
        the Psammead. They stayed at home and wrote letters to their mother.
    </div>

    <audio id="teacherAudio" src="https://res.cloudinary.com/dswvflav6/video/upload/v1770704169/ch3_shadowing_spwfot.mp3" preload="auto" crossorigin="anonymous"></audio>

    <button id="startBtn" class="btn">ğŸ”´ Start Reading (é–‹å§‹è·Ÿè®€)</button>
    <button id="stopBtn" class="btn" disabled>â¹ï¸ Stop (åœæ­¢)</button>
    
    <div id="status" class="status">Ready / æº–å‚™å°±ç·’</div>
    
    <div id="playerContainer" style="display:none; background: #edf2f7; padding: 15px; border-radius: 15px; margin-top: 10px;">
        <p style="margin:0 0 10px 0; font-size:14px; color:#4a5568;">ğŸ§ ä½ çš„ç·´ç¿’éŒ„éŸ³ï¼š</p>
        <audio id="audioPlayer" controls></audio>
    </div>
    
    <button id="uploadBtn" class="btn" style="display: none;">ğŸ“¤ Send (å‚³é€çµ¦è€å¸«)</button>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwULwx5HJzU0anAPGaxYSwDLYUPD4W0IyfXteVi8uSKtsoNuAdu9A-AeMZYcrJp81z0lg/exec"; 

    let audioContext, recorder, input, processor, wavBlob;
    let chunks = [];
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const teacherAudio = document.getElementById('teacherAudio');
    const audioPlayer = document.getElementById('audioPlayer');
    const status = document.getElementById('status');
    const studentNameInput = document.getElementById('studentName');

    startBtn.onclick = async () => {
        if (!studentNameInput.value.trim()) { 
            alert("ğŸ’¡ Jackie è€å¸«æé†’ï¼šè«‹å…ˆè¼¸å…¥å§“åå–”ï¼"); 
            return; 
        }
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // ä¿®æ­£ï¼šé‡å° iPhone é€²è¡ŒéŒ„éŸ³ç·¨ç¢¼å„ªåŒ–
            const source = audioContext.createMediaStreamSource(stream);
            recorder = audioContext.createMediaStreamDestination();
            source.connect(recorder);
            
            // åŒæ™‚æŠ“å–è€å¸«éŸ³è»Œ
            const tSource = audioContext.createMediaElementSource(teacherAudio);
            tSource.connect(recorder);
            tSource.connect(audioContext.destination);

            const mediaRecorder = new MediaRecorder(recorder.stream);
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                wavBlob = new Blob(chunks, { type: 'audio/mp3' }); // æ”¹ç”¨å»£æ³›æ”¯æ´çš„ MIME
                const url = URL.createObjectURL(wavBlob);
                audioPlayer.src = url;
                document.getElementById('playerContainer').style.display = 'block';
                uploadBtn.style.display = 'block';
                status.innerText = "ğŸ‰ éŒ„è£½å®Œæˆï¼Œå¯ä»¥è©¦è½æˆ–ç›´æ¥å‚³é€ã€‚";
            };

            chunks = [];
            teacherAudio.play();
            mediaRecorder.start();
            startBtn.disabled = true; stopBtn.disabled = false;
            status.innerText = "ğŸ”´ éŒ„éŸ³ä¸­ï¼ŒåŠ æ²¹ï¼";
        } catch (err) { alert("éº¥å…‹é¢¨å­˜å–å¤±æ•—ï¼Œè«‹ç¢ºèªæ˜¯å¦é–‹å•Ÿæ¬Šé™ã€‚"); }
    };

    stopBtn.onclick = () => {
        location.reload(); // æ‰‹æ©Ÿç‰ˆæœ€ç©©å®šçš„åœæ­¢æ–¹å¼ï¼šé‡æ–°è¼‰å…¥ç‹€æ…‹
    };
    
    // é€™è£¡æˆ‘å€‘å„ªåŒ– Stop æŒ‰éˆ•ï¼ŒåŸæœ¬çš„ stop æœ‰æ™‚æœƒå¡ä½ï¼Œæ”¹ç”¨ä¸‹é¢é€™å€‹ç›£è½
    teacherAudio.onended = () => {
        // å¦‚æœè€å¸«éŸ³æª”æ”¾å®Œäº†ï¼Œè‡ªå‹•åœæ­¢
        status.innerText = "çµæŸï¼è«‹æ‰‹å‹•é»æ“Š Stop æº–å‚™ä¸Šå‚³ã€‚";
    };

    uploadBtn.onclick = async () => {
        status.innerText = "ğŸš€ æ­£åœ¨å‚³é€æª”æ¡ˆ...";
        uploadBtn.disabled = true;
        const reader = new FileReader();
        reader.readAsDataURL(wavBlob);
        reader.onloadend = async () => {
            const base64Data = reader.result.split(',')[1];
            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        audio: base64Data,
                        className: document.getElementById('className').value,
                        name: studentNameInput.value.trim()
                    })
                });
                status.innerText = "âœ… ä¸Šå‚³æˆåŠŸï¼";
                uploadBtn.style.display = 'none';
            } catch (e) { status.innerText = "âŒ å¤±æ•—"; uploadBtn.disabled = false; }
        };
    };
</script>

</body>
</html>
