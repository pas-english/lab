<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jackie's Recording Studio</title>
    <style>
        :root { --primary: #00ff88; --gold: #fcc419; --bg: #1a1d23; --card: #252932; --text: #e0e6ed; }
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 20px; margin: 0; }
        
        .studio-container { background: var(--card); padding: 30px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-width: 600px; width: 100%; text-align: center; border: 1px solid #333; position: relative; }
        
        .media-box { width: 100%; border-radius: 16px; overflow: hidden; margin-bottom: 20px; border: 2px solid #3d4451; background: #000; }
        .media-box img { width: 100%; display: block; opacity: 0.9; }

        /* ä¸­æ–‡æ“ä½œæŒ‡å¼•å€ */
        .how-to-play { 
            background: rgba(252, 196, 25, 0.1); border-left: 4px solid var(--gold); 
            padding: 15px; margin-bottom: 20px; border-radius: 8px; 
            text-align: left; font-size: 14px; color: #ddd; line-height: 1.6;
        }
        .how-to-play b { color: var(--gold); }

        .visualizer-container { 
            background: #000; height: 100px; width: 100%; border-radius: 12px; margin-bottom: 20px; 
            position: relative; border: 1px solid var(--primary); overflow: hidden;
        }
        canvas { width: 100%; height: 100%; }

        .reading-text { 
            background: #2d333d; border: 1px solid #444; padding: 20px; border-radius: 16px; 
            text-align: left; font-size: 19px; line-height: 1.8; color: #fff; margin-bottom: 20px;
        }

        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input, select { 
            flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #444; 
            background: #1a1d23; color: #fff; font-size: 16px; outline: none;
        }

        .btn-box { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn { 
            padding: 16px; border-radius: 14px; border: none; font-weight: bold; font-size: 17px; 
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        
        #startBtn { background: #e53e3e; color: #fff; }
        #stopBtn { background: #4a5568; color: #fff; }
        #uploadBtn { background: var(--primary); color: #000; grid-column: span 2; display: none; margin-top: 10px; }
        
        .status-bar { margin-top: 15px; font-size: 15px; color: var(--primary); font-weight: bold; }
        audio { width: 100%; margin-top: 15px; filter: invert(100%) opacity: 0.7; }
        #playerLabel { text-align: left; font-size: 14px; margin: 15px 0 5px; color: var(--gold); display: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="studio-container">
    <h1 style="margin:0; font-size: 24px; color: var(--primary);">JACKIE'S AUDIO LAB</h1>
    <p style="color: #888; margin: 5px 0 20px 0; font-size: 12px;">å°ˆæ¥­è½è®€è¨“ç·´ç³»çµ±</p>

    <div class="media-box">
        <img src="https://docs.google.com/uc?export=download&id=1CpQ-jRVCk14qqb5F8gN4LeAckx2ybBhe">
    </div>

    <div class="how-to-play">
        <b>ğŸ’¡ æ“ä½œæµç¨‹ (Instructions)ï¼š</b><br>
        1. é¸æ“‡ç­ç´šä¸¦è¼¸å…¥å§“åã€‚<br>
        2. æŒ‰ <b>START</b> é–‹å§‹ï¼Œè«‹è·Ÿè‘—è€å¸«çš„è²éŸ³åŒæ­¥æœ—è®€ã€‚<br>
        3. çµæŸå¾ŒæŒ‰ <b>STOP</b> åœæ­¢éŒ„éŸ³ã€‚<br>
        4. æœ€å¾ŒæŒ‰ <b>SEND</b> å‚³é€çµ¦è€å¸«ï¼Œçœ‹åˆ°ã€ŒæˆåŠŸã€æ‰ç®—å®Œæˆã€‚
    </div>

    <div class="input-group">
        <select id="className">
            <option value="G8">ç­ç´šï¼šG8</option>
            <option value="G7">ç­ç´šï¼šG7</option>
            <option value="G9">ç­ç´šï¼šG9</option>
        </select>
        <input type="text" id="studentName" placeholder="è«‹è¼¸å…¥å­¸ç”Ÿå§“å">
    </div>

    <div class="visualizer-container">
        <canvas id="visualizer"></canvas>
    </div>

    <div class="reading-text">
        The next day was very wet. It rained all day and the children could not go to see the Psammead. They stayed at home and wrote letters to their mother. But none of them told her about the Psammead. And the day after that, their Uncle Richard came and took them out, so they didnâ€™t see the Psammead for two days. But Anthea spent a lot of time thinking about what to wish for.
    </div>

    <audio id="teacherAudio" src="https://res.cloudinary.com/dswvflav6/video/upload/v1770704169/ch3_shadowing_spwfot.mp3" preload="auto" crossorigin="anonymous"></audio>

    <div class="btn-box">
        <button id="startBtn" class="btn">ğŸ”´ START é–‹å§‹éŒ„éŸ³</button>
        <button id="stopBtn" class="btn" disabled>â¹ STOP åœæ­¢</button>
        <button id="uploadBtn" class="btn">ğŸ“¤ SEND å‚³é€çµ¦ Jackie è€å¸«</button>
    </div>
    
    <p id="status" class="status-bar">READY / æº–å‚™å°±ç·’</p>
    
    <div id="playerLabel">ğŸ§ è©¦è½ä½ çš„éŒ„éŸ³ (Preview)ï¼š</div>
    <audio id="audioPlayer" controls style="display: none;"></audio>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbznQwq6elMdN5qUyApqv2aeIWyWS2MiZBaU-I1NSt8f-eBpYQBa61VFI0jUtKKUGwAbIw/exec"; 

    let recorder, chunks = [], audioContext, dest, teacherSource, activeStream, analyser, dataArray, animationId;
    const canvas = document.getElementById('visualizer');
    const canvasCtx = canvas.getContext('2d');

    function draw() {
        animationId = requestAnimationFrame(draw);
        analyser.getByteTimeDomainData(dataArray);
        canvasCtx.fillStyle = '#000';
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        canvasCtx.lineWidth = 3;
        canvasCtx.strokeStyle = '#00ff88';
        canvasCtx.beginPath();
        let sliceWidth = canvas.width * 1.0 / analyser.frequencyBinCount;
        let x = 0;
        for(let i = 0; i < analyser.frequencyBinCount; i++) {
            let v = dataArray[i] / 128.0;
            let y = v * canvas.height / 2;
            if(i === 0) canvasCtx.moveTo(x, y);
            else canvasCtx.lineTo(x, y);
            x += sliceWidth;
        }
        canvasCtx.lineTo(canvas.width, canvas.height / 2);
        canvasCtx.stroke();
    }

    document.getElementById('startBtn').onclick = async () => {
        if (!document.getElementById('studentName').value.trim()) return alert("è«‹å…ˆè¼¸å…¥å§“åï¼");
        
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            dest = audioContext.createMediaStreamDestination();
            activeStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            const micSource = audioContext.createMediaStreamSource(activeStream);
            micSource.connect(analyser);
            micSource.connect(dest);
            
            const teacherAudio = document.getElementById('teacherAudio');
            teacherSource = audioContext.createMediaElementSource(teacherAudio);
            teacherSource.connect(dest);
            teacherSource.connect(audioContext.destination);

            recorder = new MediaRecorder(dest.stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                const player = document.getElementById('audioPlayer');
                player.src = URL.createObjectURL(blob);
                player.style.display = 'block';
                document.getElementById('playerLabel').style.display = 'block';
                document.getElementById('uploadBtn').style.display = 'flex';
                document.getElementById('status').innerText = "éŒ„éŸ³å®Œæˆï¼Œè«‹è©¦è½æˆ–å‚³é€ã€‚";
                cancelAnimationFrame(animationId);
            };

            chunks = [];
            teacherAudio.play();
            recorder.start();
            draw();
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('status').innerText = "ğŸ”´ éŒ„éŸ³ä¸­ï¼Œè«‹è·Ÿè‘—è€å¸«æœ—è®€...";
        } catch (err) { alert("ç„¡æ³•é–‹å•Ÿéº¥å…‹é¢¨ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æˆæ¬Šï¼"); }
    };

    document.getElementById('stopBtn').onclick = () => {
        recorder.stop();
        document.getElementById('teacherAudio').pause();
        document.getElementById('teacherAudio').currentTime = 0;
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        if (activeStream) activeStream.getTracks().forEach(track => track.stop());
    };

    document.getElementById('uploadBtn').onclick = async () => {
        document.getElementById('status').innerText = "ğŸš€ æª”æ¡ˆä¸Šå‚³ä¸­ï¼Œè«‹ç¨å€™...";
        document.getElementById('uploadBtn').disabled = true;
        const blob = await fetch(document.getElementById('audioPlayer').src).then(r => r.blob());
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = async () => {
            const base64 = reader.result.split(',')[1];
            await fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    audio: base64,
                    className: document.getElementById('className').value,
                    name: document.getElementById('studentName').value
                })
            });
            document.getElementById('status').innerText = "âœ… ä¸Šå‚³æˆåŠŸï¼Jackie è€å¸«å·²æ”¶åˆ°ã€‚";
            document.getElementById('uploadBtn').style.display = 'none';
        };
    };
</script>
</body>
</html>
