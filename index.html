<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jackie's Reading Lab</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f4f8; display: flex; justify-content: center; padding: 20px; }
        .classroom { background: white; padding: 30px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); max-width: 600px; width: 100%; text-align: center; }
        .reading-text { background: #fff; border: 2px solid #e2e8f0; padding: 25px; border-radius: 15px; margin: 20px 0; text-align: left; line-height: 1.8; font-size: 19px; }
        .input-group { margin-bottom: 15px; text-align: left; display: flex; gap: 10px; }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; }
        .btn { padding: 18px; font-size: 18px; margin: 10px 0; cursor: pointer; border-radius: 15px; border: none; font-weight: bold; width: 100%; }
        #startBtn { background: #e53e3e; color: white; }
        #stopBtn { background: #4a5568; color: white; }
        #uploadBtn { background: #38a169; color: white; }
        .status { margin-top: 15px; font-weight: bold; color: #2d3748; }
    </style>
</head>
<body>
<div class="classroom">
    <h1 style="margin:0;">ğŸ™ï¸ Echoing Practice</h1>
    <p style="color: #718096;">Jackie's English Reading Lab</p>
    <div class="input-group">
        <select id="className">
            <option value="General">-- é¸æ“‡ç­ç´š --</option>
            <option value="G7">G7</option><option value="G8">G8</option><option value="G9">G9</option>
            <option value="1A">1A</option><option value="1B">1B</option>
        </select>
        <input type="text" id="studentName" placeholder="è«‹è¼¸å…¥å§“å">
    </div>
    <div class="reading-text">
        The next day was very wet. It rained all day and the children could not go to see 
        the Psammead. They stayed at home and wrote letters to their mother.
    </div>
    <audio id="teacherAudio" src="https://res.cloudinary.com/dswvflav6/video/upload/v1770704169/ch3_shadowing_spwfot.mp3" crossorigin="anonymous"></audio>
    <button id="startBtn" class="btn">ğŸ”´ Start Reading</button>
    <button id="stopBtn" class="btn" disabled>â¹ï¸ Stop</button>
    <div id="status" class="status">Ready / æº–å‚™å°±ç·’</div>
    <audio id="audioPlayer" controls style="display: none; width: 100%; margin-top: 10px;"></audio>
    <button id="uploadBtn" class="btn" style="display: none;">ğŸ“¤ Send (ä¸Šå‚³æª”æ¡ˆ)</button>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwULwx5HJzU0anAPGaxYSwDLYUPD4W0IyfXteVi8uSKtsoNuAdu9A-AeMZYcrJp81z0lg/exec";

    let recorder, chunks = [], audioContext, dest, teacherSource;
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const teacherAudio = document.getElementById('teacherAudio');
    const audioPlayer = document.getElementById('audioPlayer');
    const status = document.getElementById('status');
    const studentNameInput = document.getElementById('studentName');

    startBtn.onclick = async () => {
        // ğŸŒŸ æº«é¦¨æé†’
        if (!studentNameInput.value.trim()) { 
            alert("ğŸ’¡ Jackie è€å¸«æé†’ï¼š\n\nåˆ¥å¿˜äº†å…ˆè¼¸å…¥ä½ çš„ã€å§“åã€å–”ï¼"); 
            return; 
        }
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            dest = audioContext.createMediaStreamDestination();
            const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const micSource = audioContext.createMediaStreamSource(micStream);
            micSource.connect(dest);
            
            teacherSource = audioContext.createMediaElementSource(teacherAudio);
            teacherSource.connect(dest);
            teacherSource.connect(audioContext.destination);

            recorder = new MediaRecorder(dest.stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                audioPlayer.src = URL.createObjectURL(blob);
                audioPlayer.style.display = 'block';
                uploadBtn.style.display = 'block';
                status.innerText = "ğŸ‰ éŒ„éŸ³å®Œæˆï¼è«‹æŒ‰ Send ä¸Šå‚³ã€‚";
            };
            chunks = [];
            teacherAudio.play();
            recorder.start();
            startBtn.disabled = true; stopBtn.disabled = false;
            status.innerText = "ğŸ”´ éŒ„éŸ³ä¸­...";
        } catch (err) { alert("éº¥å…‹é¢¨é–‹å•Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™ï¼"); }
    };

    stopBtn.onclick = () => {
        recorder.stop();
        teacherAudio.pause(); teacherAudio.currentTime = 0;
        audioContext.close();
        startBtn.disabled = false; stopBtn.disabled = true;
    };

    uploadBtn.onclick = async () => {
        status.innerText = "ğŸš€ ä¸Šå‚³ä¸­...";
        uploadBtn.disabled = true;
        const blob = await fetch(audioPlayer.src).then(r => r.blob());
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = async () => {
            const base64Data = reader.result.split(',')[1];
            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        audio: base64Data,
                        className: document.getElementById('className').value,
                        name: studentNameInput.value.trim()
                    })
                });
                status.innerText = "âœ… ä¸Šå‚³æˆåŠŸï¼";
                uploadBtn.style.display = 'none';
            } catch (e) { status.innerText = "âŒ å¤±æ•—"; uploadBtn.disabled = false; }
        };
    };
</script>
</body>
</html>
