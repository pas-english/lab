<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jackie's Reading Lab</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f4f8; display: flex; justify-content: center; padding: 15px; margin: 0; }
        .classroom { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 600px; width: 100%; text-align: center; box-sizing: border-box; }
        #mediaContainer { width: 100%; margin-bottom: 15px; border-radius: 15px; overflow: hidden; display: none; }
        #mediaContainer img { width: 100%; height: auto; border: 2px solid #e2e8f0; border-radius: 10px; display: block; }
        .reading-text { background: #fff; border: 2px solid #e2e8f0; padding: 20px; border-radius: 15px; margin: 15px 0; text-align: left; line-height: 1.7; font-size: 19px; color: #2d3748; min-height: 60px; white-space: pre-wrap; }
        .input-group { margin-bottom: 15px; text-align: left; }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; background: #f8fafc; box-sizing: border-box; margin-bottom: 10px; }
        .btn { padding: 18px; font-size: 18px; margin: 8px 0; cursor: pointer; border-radius: 12px; border: none; font-weight: bold; width: 100%; transition: 0.3s; }
        #startBtn { background: #e53e3e; color: white; }
        #stopBtn { background: #4a5568; color: white; }
        #uploadBtn { background: #38a169; color: white; }
        .status { margin-top: 10px; font-weight: bold; color: #2d3748; text-align: center; }
        #playerContainer { background: #edf2f7; padding: 15px; border-radius: 15px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="classroom">
    <h1 id="lessonTitle">Jackie's Reading Lab</h1>
    <div id="mediaContainer"></div>
    <div class="input-group">
        <select id="className"><option value="General">-- ÈÅ∏ÊìáÁè≠Á¥ö --</option><option value="1A">1A</option><option value="G7">G7</option><option value="G8">G8</option></select>
        <input type="text" id="studentName" placeholder="Ëº∏ÂÖ•Â≠∏ÁîüÂßìÂêç">
    </div>
    <div class="reading-text" id="lessonText">ËºâÂÖ•ÊïôÊùê‰∏≠...</div>
    <audio id="teacherAudio" preload="auto"></audio>
    <button id="startBtn" class="btn">üî¥ Start Reading</button>
    <button id="stopBtn" class="btn" disabled>‚èπÔ∏è Stop</button>
    <div id="status" class="status">Ready</div>
    <div id="playerContainer"><p style="margin:0 0 10px 0; font-weight:bold;">üéß Ë©¶ËÅΩÈåÑÈü≥Ôºö</p><audio id="audioPlayer" controls style="width: 100%;"></audio></div>
    <button id="uploadBtn" class="btn" style="display: none;">üì§ Send to Jackie</button>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbznQwq6elMdN5qUyApqv2aeIWyWS2MiZBaU-I1NSt8f-eBpYQBa61VFI0jUtKKUGwAbIw/exec"; 

    function handleResponse(data) {
        document.getElementById('lessonTitle').innerText = data.title;
        document.getElementById('lessonText').innerText = data.text;
        const teacherAudio = document.getElementById('teacherAudio');
        teacherAudio.src = data.audio;
        teacherAudio.load();
        
        const container = document.getElementById('mediaContainer');
        if (data.media_url) {
            container.innerHTML = `<img src="${data.media_url}" alt="ÊïôÊùêÂúñÁâá">`;
            container.style.display = 'block';
        }
    }

    const script = document.createElement('script');
    script.src = GAS_URL + "?callback=handleResponse";
    document.body.appendChild(script);

    let recorder, chunks = [], activeStream;
    const startBtn = document.getElementById('startBtn'), stopBtn = document.getElementById('stopBtn'), uploadBtn = document.getElementById('uploadBtn'), teacherAudio = document.getElementById('teacherAudio'), audioPlayer = document.getElementById('audioPlayer'), status = document.getElementById('status');

    startBtn.onclick = async () => {
        if (!document.getElementById('studentName').value.trim()) { alert("Ë´ãËº∏ÂÖ•ÂßìÂêçÔºÅ"); return; }
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            activeStream = stream;
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const dest = audioCtx.createMediaStreamDestination();
            const micSource = audioCtx.createMediaStreamSource(stream);
            micSource.connect(dest);
            const teacherSource = audioCtx.createMediaElementSource(teacherAudio);
            teacherSource.connect(dest);
            teacherSource.connect(audioCtx.destination);
            recorder = new MediaRecorder(dest.stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                audioPlayer.src = URL.createObjectURL(blob);
                document.getElementById('playerContainer').style.display = 'block';
                uploadBtn.style.display = 'block';
                status.innerText = "ÈåÑÈü≥ÂÆåÊàêÔºÅ";
                activeStream.getTracks().forEach(track => track.stop());
            };
            chunks = [];
            teacherAudio.play();
            recorder.start();
            startBtn.disabled = true; stopBtn.disabled = false;
            status.innerText = "üî¥ ÈåÑË£Ω‰∏≠...";
        } catch (err) { alert("È∫•ÂÖãÈ¢®ÈñãÂïüÂ§±Êïó„ÄÇ"); }
    };

    stopBtn.onclick = () => {
        if(recorder && recorder.state !== "inactive") recorder.stop();
        teacherAudio.pause(); teacherAudio.currentTime = 0;
        startBtn.disabled = false; stopBtn.disabled = true;
    };

    uploadBtn.onclick = async () => {
        status.innerText = "üöÄ ÂÇ≥ÈÄÅ‰∏≠...";
        uploadBtn.disabled = true;
        const blob = await fetch(audioPlayer.src).then(r => r.blob());
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = async () => {
            const base64Data = reader.result.split(',')[1];
            try {
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ audio: base64Data, className: document.getElementById('className').value, name: document.getElementById('studentName').value }) });
                status.innerText = "‚úÖ Â∑≤‰∏äÂÇ≥ÔºÅ";
                uploadBtn.style.display = 'none';
            } catch (e) { status.innerText = "‚ùå Â§±Êïó"; uploadBtn.disabled = false; }
        };
    };
</script>
</body>
</html>
