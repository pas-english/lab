<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jackie's Reading Lab</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f4f8; display: flex; justify-content: center; padding: 15px; margin: 0; }
        .classroom { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 600px; width: 100%; text-align: center; box-sizing: border-box; }
        .how-to-play { background: #fff9db; border-left: 5px solid #fcc419; padding: 15px; margin-bottom: 20px; border-radius: 12px; text-align: left; font-size: 14px; color: #5c5f66; line-height: 1.8; }
        
        /* ç¹ªæœ¬/åœ–ç‰‡é¡¯ç¤ºå€ */
        #mediaContainer { width: 100%; margin-bottom: 15px; border-radius: 15px; overflow: hidden; display: none; }
        #mediaContainer img { width: 100%; height: auto; border: 2px solid #e2e8f0; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        .reading-text { background: #fff; border: 2px solid #e2e8f0; padding: 20px; border-radius: 15px; margin: 15px 0; text-align: left; line-height: 1.7; font-size: 19px; color: #2d3748; min-height: 60px; height: auto; word-wrap: break-word; }
        .input-group { margin-bottom: 15px; text-align: left; display: flex; gap: 10px; flex-wrap: wrap; }
        .input-item { flex: 1; min-width: 140px; }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; background: #f8fafc; box-sizing: border-box; }
        .btn { padding: 18px; font-size: 18px; margin: 8px 0; cursor: pointer; border-radius: 12px; border: none; font-weight: bold; width: 100%; transition: 0.3s; }
        #startBtn { background: #e53e3e; color: white; }
        #stopBtn { background: #4a5568; color: white; }
        #uploadBtn { background: #38a169; color: white; }
        .status { margin-top: 10px; font-weight: bold; color: #2d3748; }
        #playerContainer { background: #edf2f7; padding: 15px; border-radius: 15px; margin-top: 10px; display: none; text-align: left; }
    </style>
</head>
<body>

<div class="classroom">
    <h1 id="lessonTitle" style="margin:0; font-size: 26px;">è¼‰å…¥æ•™æä¸­...</h1>
    <p style="color: #718096; margin: 5px 0 20px 0; font-weight: bold;">Jackie's English Reading Lab</p>

    <div class="how-to-play">
        <b>ğŸ’¡ å¼·è¿«å¼é–“éš”è¿´è²ç·´ç¿’ï¼š</b><br>
        1. é¸æ“‡ç­ç´šå§“åã€‚ 2. æŒ‰ <b>Start</b> è½è€å¸«è®€ã€‚ 3. å‹™å¿…åœ¨<b>ç©ºç™½é–“éš”</b>æ¨¡ä»¿ã€‚ 4. è®€å®ŒæŒ‰ <b>Stop</b> åœæ­¢ã€‚ 5. æŒ‰ <b>Send</b> ä¸Šå‚³ã€‚
    </div>

    <div id="mediaContainer"></div>

    <div class="input-group">
        <div class="input-item">
            <select id="className">
                <option value="General">-- é¸æ“‡ç­ç´š --</option>
                <option value="1A">1A</option><option value="G7">G7</option><option value="G8">G8</option>
            </select>
        </div>
        <div class="input-item">
            <input type="text" id="studentName" placeholder="å­¸ç”Ÿå§“å">
        </div>
    </div>

    <div class="reading-text" id="lessonText">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</div>

    <audio id="teacherAudio" preload="auto" crossorigin="anonymous"></audio>

    <button id="startBtn" class="btn">ğŸ”´ Start Reading (é–‹å§‹è·Ÿè®€)</button>
    <button id="stopBtn" class="btn" disabled>â¹ï¸ Stop (åœæ­¢ä¸¦è©¦è½)</button>
    
    <div id="status" class="status">Ready</div>
    
    <div id="playerContainer">
        <p style="margin:0 0 10px 0; font-size:14px; font-weight:bold;">ğŸ§ ä½ çš„ç·´ç¿’éŒ„éŸ³ï¼š</p>
        <audio id="audioPlayer" controls></audio>
    </div>
    
    <button id="uploadBtn" class="btn" style="display: none;">ğŸ“¤ Send (å‚³é€çµ¦è€å¸«)</button>
</div>

<script>
    // ğŸŒŸ é€™è£¡è«‹è²¼ä¸Šæ‚¨æœ€æ–°éƒ¨ç½²å¾—åˆ°çš„ GAS ç¶²å€
    const GAS_URL = "æ‚¨çš„_GAS_ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€"; 

    let recorder, chunks = [], activeStream;

    // 1. å¾è©¦ç®—è¡¨åŒæ­¥æ•™æ
    async function loadLesson() {
        try {
            const res = await fetch(GAS_URL);
            const data = await res.json();
            
            document.getElementById('lessonTitle').innerText = "ğŸ™ï¸ " + (data.title || "Echoing Practice");
            document.getElementById('lessonText').innerText = data.text || "ç›®å‰æ²’æœ‰èª²æ–‡å…§å®¹";
            document.getElementById('teacherAudio').src = data.audio;
            
            const container = document.getElementById('mediaContainer');
            if (data.media_type === "image" && data.media_url) {
                container.innerHTML = `<img src="${data.media_url}" alt="Picture Book">`;
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        } catch (e) {
            document.getElementById('lessonText').innerText = "ç„¡æ³•è®€å–æ•™æï¼Œè«‹æª¢æŸ¥ GAS éƒ¨ç½²æ¬Šé™ã€‚";
        }
    }
    loadLesson();

    // 2. éŒ„éŸ³é‚è¼¯
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const teacherAudio = document.getElementById('teacherAudio');
    const audioPlayer = document.getElementById('audioPlayer');
    const status = document.getElementById('status');

    startBtn.onclick = async () => {
        if (!document.getElementById('studentName').value.trim()) { alert("è«‹è¼¸å…¥å§“åï¼"); return; }
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            activeStream = stream;
            
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const dest = audioCtx.createMediaStreamDestination();
            
            const micSource = audioCtx.createMediaStreamSource(stream);
            micSource.connect(dest);
            
            const teacherSource = audioCtx.createMediaElementSource(teacherAudio);
            teacherSource.connect(dest);
            teacherSource.connect(audioCtx.destination);

            recorder = new MediaRecorder(dest.stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                audioPlayer.src = URL.createObjectURL(blob);
                document.getElementById('playerContainer').style.display = 'block';
                uploadBtn.style.display = 'block';
                status.innerText = "éŒ„éŸ³å®Œæˆï¼å¯è©¦è½å¾Œå‚³é€ã€‚";
                activeStream.getTracks().forEach(track => track.stop());
            };

            chunks = [];
            teacherAudio.play();
            recorder.start();
            startBtn.disabled = true; stopBtn.disabled = false;
            status.innerText = "ğŸ”´ æ­£åœ¨éŒ„éŸ³ä¸­...";
        } catch (err) { alert("éº¥å…‹é¢¨å­˜å–å¤±æ•—ï¼Œè«‹ç¢ºèªæ˜¯å¦é–‹å•Ÿæ¬Šé™ã€‚"); }
    };

    stopBtn.onclick = () => {
        recorder.stop();
        teacherAudio.pause(); teacherAudio.currentTime = 0;
        startBtn.disabled = false; stopBtn.disabled = true;
    };

    uploadBtn.onclick = async () => {
        status.innerText = "ğŸš€ æ­£åœ¨å‚³é€çµ¦è€å¸«...";
        uploadBtn.disabled = true;
        const blob = await fetch(audioPlayer.src).then(r => r.blob());
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = async () => {
            const base64Data = reader.result.split(',')[1];
            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        audio: base64Data,
                        className: document.getElementById('className').value,
                        name: document.getElementById('studentName').value
                    })
                });
                status.innerText = "âœ… ä¸Šå‚³æˆåŠŸï¼";
                uploadBtn.style.display = 'none';
            } catch (e) { status.innerText = "âŒ å‚³é€å¤±æ•—"; uploadBtn.disabled = false; }
        };
    };
</script>
</body>
</html>
